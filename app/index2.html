<html>
  <head>
    <meta charset="utf-8" />
    <title>AIdeaText - Web</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  </head>
  <body>
    <header>AIdeaText - Web </header>

    <div class="container">
      <div class="left">
        <button id="submitButton">Visualiza</button>
        <textarea id="inputText"></textarea>
      </div>

      <div class="right">
        <div id="outputDiv"></div>
      </div>
    </div>

    <script type="text/javascript">
      async function loadNLTKAndResources(pyodide) {
         await pyodide.loadPackage(['micropip', 'numpy', 'matplotlib', 'networkx']);
        
        const micropip = pyodide.pyimport("micropip");
        await micropip.install("nltk");
        
        await pyodide.runPythonAsync(`
          import nltk
          from nltk.data import path
          # Configura las rutas de NLTK para usar archivos locales
          path.append('https://raw.githubusercontent.com/aideatext/AIdeaTextWeb/main/app/nltk_data/tokenizers/punkt.zip')
        `);
      }

      async function main() {
        let pyodide = await loadPyodide();
        await loadNLTKAndResources(pyodide);

        document.getElementById('submitButton').addEventListener('click', function() {
          const inputText = document.getElementById('inputText').value;
          const cleanedText = cleanText(inputText, pyodide);
          processText(cleanedText, pyodide).then(imgBase64 => {
            document.getElementById('outputDiv').innerHTML = '<img src="data:image/png;base64,' + imgBase64 + '">';
          }).catch(console.error);
        });
      }

      function cleanText(text, pyodide) {
        return pyodide.runPython(`
          from nltk.tokenize import word_tokenize
          from nltk.corpus import stopwords
          tokens = word_tokenize(text)
          tokens = [word for word in tokens if word.isalpha()]
          stop_words = set(stopwords.words('spanish'))
          tokens = [word for word in tokens if not word in stop_words]
          return tokens
        `);
      }

      function processText(tokens, pyodide) {
        return pyodide.runPython(`
          import matplotlib.pyplot as plt
          import networkx as nx
          import io
          import base64

          graph = nx.Graph()
          for i in range(len(tokens) - 1):
              graph.add_edge(tokens[i], tokens[i + 1])

          plt.rcParams["figure.figsize"] = (21,17)
          nx.draw(graph, with_labels=True)

          img = io.BytesIO()
          plt.savefig(img, format='png')
          img.seek(0)

          img_base64 = base64.b64encode(img.read()).decode('utf-8')
          return img_base64
        `);
      }

      main();
    </script>
  </body>
</html>

